<?
if (!defined('B_PROLOG_INCLUDED') || B_PROLOG_INCLUDED !== true) die();
class companyReveiws
{
    const DEBUG = false;
    /**
     * @link https://developers.google.com/places/web-service/details
     * ะะ ะดะปั ะฟะพะปััะตะฝะธั ะบะปััะตะน ะธ ะฝะฐัััะพะนะบะธ OAuth 2.0
     * @link https://console.developers.google.com/apis/credentials?authuser=0&project=data-avatar-217514
     * ัะฟัะฐะฒะบะธ ะฟะพ ะพัะทัะฒะฐะผ ะดะปั mybusiness
     * @link https://stackoverflow.com/questions/48007574/how-to-use-google-my-business-api-to-get-the-reviews-and-reply-to-that
     * @link https://developers.google.com/my-business/reference/rest/v4/accounts.locations.reviews
     * ะกะฟัะฐะฒะบะฐ ะฟะพ OAuth 2.0 ั ะฑะธะฑะปะธะพัะตะบะฐะผะธ
     * @link https://developers.google.com/identity/protocols/OAuth2
     * ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ัะฐะฑะพัั ัะตัะตะท mybusiness, ะบะพัะพััะน ะฟัะตะดะพััะฐะฒะปัะตั ะฒะพะทะผะพะถะฝะพััั ัะพััะธัะพะฒะพะบ ะฒะพะทัะฒะฐัะฐะตะผัั ะฟะฐัะฐะผะตััะพะฒ, ะฟะพัะพะถะต ะฝะตะพะฑัะพะดะธะผะพ ัะตะฐะปะธะทะพะฒะฐัั ะฟะพะดะบะปััะตะฝะธะต ัะตัะตะท OAuth ะฝะฐ ัะตัะฒะตัะฐ ะณัะณะป, ะฟะพะปััะธัั ัะพะบะตะฝ ะธ ะฟะพะดััะฐะฒะธัั ะตะณะพ ะฒ ัััะปะบั
     *
     * @param $params
     * @return string
     */
    public function getReviewsUrl($params)
    {
        if ($params['USE_MYBUSINESS'] == 'Y') {
            $url = 'https://mybusiness.googleapis.com/v4/accounts/' . $params['ACCOUNT_ID'] . '/locations/' . $params['LOCATION_ID'] . '/reviews?access_token=' . $params['AUTH_TOKEN'];
        } else {
            $fields = '&fields=rating,user_ratings_total,reviews&language=ru';
            $url = 'https://maps.googleapis.com/maps/api/place/details/json?placeid=' . $params['PLACE_ID'] . $fields . '&key=' . $params['AUTH_TOKEN'];
        }
        return $url;
    }

    public function getGoogleReviews($params)
    {
        $url = self::getReviewsUrl($params);
        if(self::DEBUG) {
            $result = self::getExampleByPlacesApi();
            return json_decode($result, true);
        }
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15);
        $result = curl_exec($ch);

        if (curl_errno($ch)) {
            $error_msg = curl_error($ch);
            #@TODO ััั ะปะพะณะธัะพะฒะฐัั ะพ ะฟัะพะฑะปะตะผะต, ะตัะปะธ ััะพ ะฝัะถะฝะพ
        }
        curl_close($ch);
        return json_decode($result, true);
    }

    public function getExampleByPlacesApi()
    {
        $response = '{
           "html_attributions" : [],
           "result" : {
              "rating" : 4.7,
              "reviews" : [
                 {
                    "author_name" : "ะะฐัะธะฝะฐ ะะฐะดะฐะฝะธะฝะฐ",
                    "author_url" : "https://www.google.com/maps/contrib/114130535622557375464/reviews",
                    "language" : "ru",
                    "profile_photo_url" : "https://lh3.googleusercontent.com/-GuyXp4yERo4/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rf1VQKVlqCzgZrApGpjd4rAGqQH8w/s128-c0x00000000-cc-rp-mo/photo.jpg",
                    "rating" : 5,
                    "relative_time_description" : "3 ะฝะตะดะตะปะธ ะฝะฐะทะฐะด",
                    "text" : "ะะพะดะฝะฐั ะผะตะฑะตะปั ะธ ะฟัะตะดะผะตัั ะดะตะบะพัะฐ, ัะดะพะฑะฝะฐั ะฝะฐะฒะธะณะฐัะธั ะฟะพ ัะฐะนัั, ะฑะพะปััะพะน ะฐััะพััะธะผะตะฝั, ะดะพัััะฟะฝัะต ัะตะฝั, ะธ ััะบะธะน ะะฝััะฐะณัะฐะผ ะฐะบะบะฐัะฝั ั ัะตะฐะปัะฝัะผะธ ะพัะทัะฒะฐะผะธ ะดะพะฒะพะปัะฝัั  ะฟะพะบัะฟะฐัะตะปะตะน. ะ ะผะฐะณะฐะทะธะฝะต ัะฐััะพ ะฟัะพัะพะดัั ะฐะบัะธะธ ะธ ัะพะทัะณัััะธ. \nะฏ ะทะฐะบะฐะทะฐะปะฐ ััะพะป ะธ ัััะปัั, ััะพะป ะฑัะป ะฒ ะฝะฐะปะธัะธะธ ะฒ ะธะฝัะตัะฝะตั ะผะฐะณะฐะทะธะฝะต, ะฝะพ ะฟัะธ ะฟัะพะฒะตัะบะต ะทะฐะบะฐะทะฐ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน  ะพะฑะฝะฐััะถะธะปะพัั, ััะพ ะบ ะฝะตะผั ะฝะต ัะฒะฐัะฐะตั ะบะพะผะฟะปะตะบััััะธั, ะพ ัะตะผ ะผะตะฝั ัะฒะตะดะพะผะธะปะธ ะฟะพ ัะตะปะตัะพะฝั ะธ ะฟัะตะดะปะพะถะธะปะธ ะฟะพะดะพะถะดะฐัั ัะปะตะดัััะตะน ะฟะพััะฐะฒะบะธ. ะะดะฝะฐะบะพ ะฟะพััะฐะฒะบะฐ ะทะฐะดะตัะถะธะฒะฐะปะฐัั, ะฐ ะฒ ััะพ ะฒัะตะผั ะฒ ะผะฐะณะฐะทะธะฝะต ะฟัะพัะพะดะธะปะฐ ะฐะบัะธั ะธ ะผะพะธ ัััะปัั ััะฐะปะธ ััะพะธัั ะดะตัะตะฒะปะต. ะฏ ะฝะตะผะฝะพะณะพ ัะฐััััะพะธะปะฐัั, ะฒะตะดั ะทะฐ ัััะปัั ั ัะถะต ะทะฐะฟะปะฐัะธะปะฐ, ะฐ ะฟะพ ัะฐะบัั ะธั ะฝะต ะฟะพะปััะธะปะฐ. ะ ะธัะพะณะต ั ะฝะฐัะปะฐ ะฟะพะดัะพะดััะธะน ััะพะป ะฒ ะดััะณะพะผ ะผะฐะณะฐะทะธะฝะต, ะธ ัะตัะธะปะฐ ะพัะผะตะฝะธัั ะทะฐะบะฐะท ะฝะฐ ััะพะป.  ะะฝะต ะฑะตะท ะฒะพะฟัะพัะพะฒ ะพัะผะตะฝะธะปะธ ะทะฐะบะฐะท, ะฟะตัะตััะธัะฐะปะธ ััะพะธะผะพััั ัััะปัะตะฒ ั ััะตัะพะผ ัะบะธะดะบะธ, ะธ ะฝะฐ ัะปะตะดัััะธะน ะดะตะฝั ะพะฝะธ ัะถะต ััะพัะปะธ ะฝะฐ ะผะพะตะน ะบััะฝะต! ะะตะฒะพัะบะธ ะบะพะฝััะปััะฐะฝัั ะฟัะพััะพ ัะผะฝะธัะบะธ, ะฒะตะถะปะธะฒัะต, ะบะพะผะฟะตัะตะฝัะฝัะต ะพัะตะฝั ะฟัะธััะฝะพ ะฑัะปะพ ั ะฝะธะผะธ ะพะฑัะฐัััั. ะะพััะฐะฒะบะฐ ัะพะถะต ะฟะพัะฐะดะพะฒะฐะปะฐ, ะบัััะตั ะดะพััะฐะฒะธะป ะทะฐะบะฐะท ะฟััะผะพ ะดะพ ะบะฒะฐััะธัั. ะกััะปัั ััะฐัะตะปัะฝะพ ัะฟะฐะบะพะฒะฐะฝั, ะฒัะต ะบะพะผะฟะปะตะบััััะธะต ะฝะฐ ะผะตััะต. \nะะดะฝะพะทะฝะฐัะฝะพ ัะตะบะพะผะตะฝะดัั ััะพั ะธะฝัะตัะฝะตั ะผะฐะณะฐะทะธะฝ. ะฃะดะฐัะฝัั ะฒะฐะผ ะฟะพะบัะฟะพะบ!",
                    "time" : 1563657007
                 },
                 {
                    "author_name" : "ะััะตะผ ะ",
                    "author_url" : "https://www.google.com/maps/contrib/103669447799466125129/reviews",
                    "language" : "ru",
                    "profile_photo_url" : "https://lh3.googleusercontent.com/-OeNXSyCxjao/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3reeOtQO2IOTsUKtY9vNaIBj_0Ua5w/s128-c0x00000000-cc-rp-mo/photo.jpg",
                    "rating" : 5,
                    "relative_time_description" : "ะผะตะฝััะต ะฝะตะดะตะปะธ ะฝะฐะทะฐะด",
                    "text" : "ะะฝะพั ะฑัะป ะฟัะธะพะฑัะตััะฝ ะบะพะผะฟะปะตะบั ััะพะป ะธ 4 ัััะปะฐ Eames Style. ะะพััะฐะฒะบะฐ ะพัััะตััะฒะปัะปะฐัั ะฒัะตะณะพ 3 ะดะฝั, ะฒัะต ะฑัะปะพ ะฐะบะบััะฐัะฝะพ ัะฟะฐะบะพะฒะฐะฝะพ ะธ ัะปะพะถะตะฝะพ ะฒ ะบะพัะพะฑะบะธ. ะััะฐัะธ, ะบะพัะพะฑะบะธ ะดะพััะฐัะพัะฝะพ ะปัะณะบะธะต. ะะพะผะฟะปะตะบั ะพัะตะฝั ะดะพะฑัะพัะฝัะน, ะบัะฐัะธะฒัะน ะธ ะบะพะผัะพััะฝัะน. ะฏ ะพััะฐะปะฐัั ะดะพะฒะพะปัะฝะฐ ะฟะพะบัะฟะบะพะน ะธ ะบะฐัะตััะฒะพะผ ะผะตะฑะตะปะธ. ะัะดะตะปัะฝะพะต ัะฟะฐัะธะฑะพ ะฟัะตะบัะฐัะฝะพะน ะบะพะผะฐะฝะดะต ะผะฐะณะฐะทะธะฝะฐ ะทะฐ ะพะฟะตัะฐัะธะฒะฝะพััั ะธ ะฟัะพัะตััะธะพะฝะฐะปะธะทะผ!",
                    "time" : 1565294598
                 },
                 {
                    "author_name" : "Violetta Balakireva",
                    "author_url" : "https://www.google.com/maps/contrib/104753532438027393231/reviews",
                    "language" : "ru",
                    "profile_photo_url" : "https://lh5.googleusercontent.com/-N3zCO_cxKIo/AAAAAAAAAAI/AAAAAAAAAkk/NsYnY3Z3eqk/s128-c0x00000000-cc-rp-mo/photo.jpg",
                    "rating" : 5,
                    "relative_time_description" : "ะผะตะฝััะต ะฝะตะดะตะปะธ ะฝะฐะทะฐะด",
                    "text" : "ะฅะพัะพัะธะน ัะฐะนั ั ัะดะพะฑะฝัะผ ะธะฝัะตััะตะนัะพะผ. ะัะตะฝั ะฟัะธััะฝัะต ะผะตะฝะตะดะถะตัั! ะะพััะฐะฒะบั ะทะฐะบะฐะทัะฒะฐะปะฐ ะดะพ ะฟัะฝะบัะฐ ัะฐะผะพะฒัะฒะพะทะฐ. ะัั ะฟัะธะฒะตะทะปะธ ะฒ ััะพะบ. ะกััะปัั ะฑัะปะธ ัะฟะฐะบะพะฒะฐะฝั ะบะฐัะตััะฒะตะฝะฝะพ. ะฃะถะต ัะตะบะพะผะตะฝะดัั ััะพั ะผะฐะณะฐะทะธะฝ ัะฒะพะธ ะดััะทััะผ ะธ ะบะพะปะปะตะณะฐะผ!",
                    "time" : 1565356613
                 },
                 {
                    "author_name" : "ะะธัะฐะปะธะน ะััะฐะบะธะฝ",
                    "author_url" : "https://www.google.com/maps/contrib/110823420226147437504/reviews",
                    "language" : "ru",
                    "profile_photo_url" : "https://lh4.googleusercontent.com/-5pUk9GHOz1M/AAAAAAAAAAI/AAAAAAAAAHE/-6_t6b0gqZc/s128-c0x00000000-cc-rp-mo/photo.jpg",
                    "rating" : 5,
                    "relative_time_description" : "ะผะตะฝััะต ะฝะตะดะตะปะธ ะฝะฐะทะฐะด",
                    "text" : "ะะพะบัะฟะฐัะตะปั ะธะท ะณ. ะะฐะปัะณะธ. ะัะธะพะฑัะตัะฐะปะฐ ััะพะป ะธ ัััะปัั. ะะปะฐะณะพะดะฐัั ะะฝัะตัะฝะตั-ะผะฐะณะฐะทะธะฝ. ะัะบัะตะฝะฝะต ะดะพะฒะพะปัะฝะฐ ะฒะทะฐะธะผะพะพัะฝะพัะตะฝะธัะผะธ. ะัะตะฝั ะบะปะธะตะฝัะพะพัะธะตะฝัะธัะพะฒะฐะฝะฝัะต ะธ ะฟัะพัะตััะธะพะฝะฐะปัะฝะพ ะณัะฐะผะพัะฝัะต ะผะตะฝะตะดะถะตัั, ัะพัะธะตะฝัะธัะพะฒะฐะปะธ ะฟะพ ะฐััะพััะธะผะตะฝัั, ะดะฐะปะธ ะฟะพะปะตะทะฝัะต ัะพะฒะตัั ะฟะพ ะดะพััะฐะฒะบะต, ะฒััะปะฐะปะธ ะดะพะณะพะฒะพั , ะฑัะปะธ ะฒัะตะณะดะฐ ะฝะฐ ัะฒัะทะธ. ะะพ ััะพะบะฐะผ ะฒัะต ะฑัะปะพ ัะตัะบะพ ัะพะฑะปัะดะตะฝะพ. ะขะพะฒะฐั ะฑัะป ัะฟะฐะบะพะฒะฐะฝ ะพัะตะฝั ะฐะบะบััะฐัะฝะพ.  ะะฐัะตััะฒะพะผ ัะพะฒะฐัะฐ ัะพะถะต ะพัะตะฝั ะดะพะฒะพะปัะฝะฐ, ะฒ ัะฒะพะตะผ ะณะพัะพะดะต ะฝะต ะผะพะณะปะฐ ะฝะฐะนัะธ ััะตะฑัะตะผัะน ััะฝะบัะธะพะฝะฐะป.",
                    "time" : 1565356232
                 },
                 {
                    "author_name" : "ะฎะปะธั ะัะฑะฐัะตะฒะฐ",
                    "author_url" : "https://www.google.com/maps/contrib/114159316408350142459/reviews",
                    "language" : "ru",
                    "profile_photo_url" : "https://lh4.googleusercontent.com/-vYzzfgDJntQ/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcl4pQphajzjtDV0lc34llvZbHp6Q/s128-c0x00000000-cc-rp-mo/photo.jpg",
                    "rating" : 5,
                    "relative_time_description" : "ะผะตะฝััะต ะฝะตะดะตะปะธ ะฝะฐะทะฐะด",
                    "text" : "ะััะฐะปะฐัั ะพัะตะฝั ะดะพะฒะพะปัะฝะฐ ะผะฐะณะฐะทะธะฝะพะผ. ะะฐะบะฐะทัะฒะฐะปะฐ ัััะปััะธะบ, ะพัะตะฝั ะฑััััะพ ะดะพััะฐะฒะธะปะธ . ะัะต ะฟัะธัะปะพ ะฒ ัะตะปะพััะธ ะธ ัะพััะฐะฝะฝะพััะธ. ะกะฐะผ ัััะปััะธะบ ัะดะพะฑะฝัะน ะธ ะบะฐัะตััะฒะตะฝะฝัะน, ะพัะปะธัะฝะพ ะฒะฟะธัะฐะปัั ะฒ ะธะฝัะตััะตั.\n100% ัะตะบะพะผะตะฝะดัั ะธ ัะฐะผะฐ ะฑัะดั ะทะฐะบะฐะทัะฒะฐัั ะตัะต๐๐ป",
                    "time" : 1565166528
                 }
              ],
              "user_ratings_total" : 215
           },
           "status" : "OK"
        }';
        return $response;
    }
}